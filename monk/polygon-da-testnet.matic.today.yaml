namespace: /polygon

da-validator-1:
  defines: runnable
  inherits: ./da-validator
  variables:
    self_id: "da-validator-1"
    node_key: <- act("/polygon/da-vault/get_as_json", "path", "secret/da/testnet/da-validator-1") parse-json get-member("keynode") get-member("sk")
    name: MATIC_VALIDATOR_1
    volume-data: /mnt/volume/da/validator/1
    cmds: <- "--force-authoring --reserved-nodes /dns4/" get-hostname("/polygon/da-validator-2", "da-node") "/tcp/30333/p2p/12D3KooWQtxig5HukFDwQzshGWgQEZAqGqdCN7AQBW7cQRJWCyxL --reserved-nodes /dns4/" get-hostname("/polygon/da-validator-3", "da-node") "/tcp/30333/p2p/12D3KooW9tVuCzq3eknsevL5uyqQ3LpVcuqtkTqropjNccbhsWBz " concat-all

da-aws-validator-1:
  defines: runnable
  inherits: ./da-validator-1
  variables:
    self_id: "da-aws-validator-1"
    volume-data: /mnt/volume/da/
    cmds: <- "--reserved-nodes /dns4/" get-hostname("/polygon/da-aws-validator-2", "da-node") "/tcp/30333/p2p/12D3KooWQtxig5HukFDwQzshGWgQEZAqGqdCN7AQBW7cQRJWCyxL --reserved-nodes /dns4/" get-hostname("/polygon/da-aws-validator-3", "da-node") "/tcp/30333/p2p/12D3KooW9tVuCzq3eknsevL5uyqQ3LpVcuqtkTqropjNccbhsWBz" concat-all
  affinity:
    defines: affinity
    name: da-val-1
    resident: true
  volumes:
    defines: volumes
    da_state_1:
      size: 64
      kind: SSD
      path: /mnt/volume/da/


da-validator-2:
  defines: runnable
  inherits: ./da-validator
  variables:
    self_id: "da-validator-2" 
    node_key: <- act("/polygon/da-vault/get_as_json", "path", "secret/da/testnet/da-validator-2") parse-json get-member("keynode") get-member("sk")
    name: MATIC_VALIDATOR_2
    volume-data: /mnt/volume/da/validator/2
    cmds: <- "--bootnodes /dns4/" get-hostname("/polygon/da-validator-1", "da-node") "/tcp/30333/p2p/12D3KooWK1NcYjwpyRUYVG9tjp7X2iGbrQxNVafC5hJU9mggYTgv --reserved-nodes /dns4/" get-hostname("/polygon/da-validator-3", "da-node") "/tcp/30333/p2p/12D3KooW9tVuCzq3eknsevL5uyqQ3LpVcuqtkTqropjNccbhsWBz " concat-all

da-aws-validator-2:
  defines: runnable
  inherits: ./da-validator-2
  variables:
    self_id: "da-aws-validator-2"
    cmds: <- "--bootnodes /dns4/" get-hostname("/polygon/da-aws-validator-1", "da-node") "/tcp/30333/p2p/12D3KooWK1NcYjwpyRUYVG9tjp7X2iGbrQxNVafC5hJU9mggYTgv  --reserved-nodes /dns4/" get-hostname("/polygon/da-aws-validator-3", "da-node")  "/tcp/30333/p2p/12D3KooW9tVuCzq3eknsevL5uyqQ3LpVcuqtkTqropjNccbhsWBz" concat-all 
  affinity:
    defines: affinity
    name: da-val-2
  volumes:
    defines: volumes
    da_state_2:
      size: 64
      kind: SSD
      path: <- $volume-data


da-validator-3:
  defines: runnable
  inherits: ./da-validator
  variables:
    self_id: "da-validator-3"
    node_key: <- act("/polygon/da-vault/get_as_json", "path", "secret/da/testnet/da-validator-3") parse-json get-member("keynode") get-member("sk")
    name: MATIC_VALIDATOR_3
    volume-data: /mnt/volume/da/validator/3
    cmds: <- "--bootnodes /dns4/" get-hostname("/polygon/da-validator-1", "da-node") "/tcp/30333/p2p/12D3KooWK1NcYjwpyRUYVG9tjp7X2iGbrQxNVafC5hJU9mggYTgv --reserved-nodes /dns4/" get-hostname("/polygon/da-validator-2", "da-node") "/tcp/30333/p2p/12D3KooWQtxig5HukFDwQzshGWgQEZAqGqdCN7AQBW7cQRJWCyxL " concat-all

da-aws-validator-3:
  defines: runnable
  inherits: ./da-validator-3
  variables:
    self_id: "da-aws-validator-3"
    cmds: <- "--bootnodes /dns4/" get-hostname("/polygon/da-aws-validator-1", "da-node") "/tcp/30333/p2p/12D3KooWK1NcYjwpyRUYVG9tjp7X2iGbrQxNVafC5hJU9mggYTgv --reserved-nodes /dns4/" get-hostname("/polygon/da-aws-validator-2", "da-node") "/tcp/30333/p2p/12D3KooWQtxig5HukFDwQzshGWgQEZAqGqdCN7AQBW7cQRJWCyxL -lruntime::election-provider=trace" concat-all 
  affinity:
    defines: affinity
    name: da-val-3
  volumes:
    defines: volumes
    da_state_3:
      size: 64
      kind: SSD
      path: <- $volume-data


#  Secure Vault 
#  ===============================

da-vault:
  defines: runnable
  inherits: vault/latest
  affinity:
    defines: affinity
    tag: service
  volumes:
    defines: volumes
    vault-data:
      size: 4
      kind: SSD
      path: <- $volume-data
  containers:
    defines: containers
    vault:
      image-tag: 1.9.4
      # entrypoint: "docker-entrypoint.sh server"
      paths: 
        - <-`${volume-data}:/vault/file`
      #ports:
      #  - 0.0.0.0:8200:8200
      environment:
        - VAULT_CLI_NO_COLOR=1
        - SKIP_SETCAP=1
        - <- `VAULT_DEV_ROOT_TOKEN_ID=${root-token}`
        - <- `VAULT_TOKEN=${root-token}`
  variables:
    root-token: "da-root-test"
    volume-data: /mnt/vault-data
  actions:
    defines: actions
    get_as_json:
      description: Get value as Json
      arguments:
        path:
          type: string
          description: Value path
      code: exec("vault", "/bin/sh", "-c", `VAULT_TOKEN=${root-token} VAULT_CLI_NO_COLOR=true vault kv get -address=http://127.0.0.1:8200 -format=json ${args["path"]}`) trim parse-json get-member("data") get-member("data") to-json
  files:
    defines: files
    da-val-def:
      container: vault 
     # path: /vault/config/local.json
      path: /local.json
      mode: 644
      contents: |
        {
          "backend": {
            "file": {
              "path": "/vault/file"
            }
          },
          "listener": {
            "tcp":{
              "address": "0.0.0.0:8200",
              "tls_disable": 1
            }
          },
          "ui": true,
          "disable_mlock": true,
          "default_lease_ttl": "168h", 
          "max_lease_ttl": "720h"
        }

# TODO
#  - Vault to AWS volume.

# Explorer Node
# ======================================

da-explorer:
  defines: runnable
  inherits: ./da-common-node
  containers:
    defines: containers
    dapp:
      image: 0xpolygon/avail-apps:ava-107
      environment:
        - <- `WS_URL=ws://${full_node}:${ws_port}`
    redis:
      image:  redis:6-alpine
      entrypoint: "redis-server --save 60 1"
      paths:
        - <- `${volume-data}/redis/data:/data`
    proxy:
      image: kong:2.6.0-alpine
      environment:
        # General
        - KONG_PROXY_ACCESS_LOG=/dev/stdout
        - KONG_ADMIN_ACCESS_LOG=/dev/stdout
        - KONG_PROXY_ERROR_LOG=/dev/stderr
        - KONG_ADMIN_ERROR_LOG=/dev/stderr
        - KONG_ADMIN_LISTEN=0.0.0.0:8001
        # Proxy DB-less & Declarative
        - KONG_DATABASE=off
        - KONG_DECLARATIVE_CONFIG=/proxy/kong.yml
        # Acme Plugin
        - KONG_LUA_SSL_TRUSTED_CERTIFICATE=system
      ports:
        - 0.0.0.0:80:8000
        - 0.0.0.0:443:8443

  variables:
    defines: variables
    web_domain:
      type: string
      value: "devnet-avail.polygon.technology"
    full_node:
      type: string
      value: ""
    dapp:
      type: string
      value: ""
    redis:
      type: string
      value: ""
    light_client:
      type: string
      value: ""
    ws_max_connections:
      type: int
      value: 10000
    m_da_val_1_node: <- get-hostname("/polygon/da-aws-validator-1", "da-node")
    m_da_val_2_node: <- get-hostname("/polygon/da-aws-validator-2", "da-node")
    m_da_val_3_node: <- get-hostname("/polygon/da-aws-validator-3", "da-node")
  files:
    defines: files
    da-exp-def:
      container: da-node 
      path: /da/bin/da.sh
      mode: 755 
      contents: |
        #!/bin/bash
        cat /da/bin/da.sh ;
        /da/bin/data-avail \
          --chain {{ v "chain_spec" }} \
          --base-path /da/state \
          --name {{ v "name" }} \
          --node-key {{ v "node_key" }} \
          --execution Native \
          --sync Fast \
          --ws-max-connections {{ v "ws_max_connections" }} \
          --in-peers  {{ v "in_peers" }} \
          --out-peers {{ v "out_peers" }} \
          --port {{ v "p2p_port" }} \
          --ws-port {{ v "ws_port" }} \
          --ws-external \
          --rpc-port {{ v "rpc_port" }} \
          --rpc-cors all \
          --rpc-external \
          --bootnodes /dns4/{{ v "m_da_val_1_node" }}/tcp/30333/p2p/12D3KooWK1NcYjwpyRUYVG9tjp7X2iGbrQxNVafC5hJU9mggYTgv \
          --reserved-nodes /dns4/{{ v "m_da_val_2_node" }}/tcp/30333/p2p/12D3KooWQtxig5HukFDwQzshGWgQEZAqGqdCN7AQBW7cQRJWCyxL \
          --reserved-nodes /dns4/{{ v "m_da_val_3_node" }}/tcp/30333/p2p/12D3KooW9tVuCzq3eknsevL5uyqQ3LpVcuqtkTqropjNccbhsWBz \
          {{ v "cmds" }} 2>&1
    kong_yml:
      container: proxy
      path: /proxy/kong.yml
      mode: 444
      contents: |
        _format_version: "2.1"
        services:
          - name: full_node_ws 
            url: http://{{ v "full_node" }}:{{ v "ws_port" }}
            routes:
            - name: ws_route
              protocols: ["https", "http"]
              paths: ["/ws"]
              request_buffering: false
              response_buffering: false
              strip_path: true
          - name: full_node_rpc
            url: http://{{ v "full_node" }}:{{ v "rpc_port" }}
            routes:
            - name: rpc_route
              protocols: ["https", "http"]
              paths: ["/rpc"]
              request_buffering: false
              response_buffering: false
              strip_path: true
          - name: dapp
            url: http://{{ v "dapp" }}
            routes:
            - name: web_root_route
              protocols: ["https", "http"]
              paths: ["/"]
              request_buffering: false
              response_buffering: false
              strip_path: true
          - name: light_client 
            url: http://{{ v "light_client" }}:7000/
            routes:
            - name: light_client_route
              protocols: ["https", "http"]
              paths: ["/light"]
              request_buffering: false
              response_buffering: false
              strip_path: true
          - name: acme-dummy
            url: http://127.0.0.1:65535
            routes:
            - name: acme-dummy
              protocols: ["http"]
              paths: ["/.well-known/acme-challenge"]
        plugins:
          - name: acme
            config:
              account_email: miguel@polygon.technology
              domains: [ {{ v "web_domain" }}]
              tos_accepted: true
              storage: "redis"
              storage_config:
                redis:
                  host: {{ v "redis" }}

da-explorer-1:
  defines: runnable
  inherits: ./da-explorer
  containers:
    defines: containers
    da-node:
      ports:
        - <- `0.0.0.0:${ws_port}:${ws_port}`
        - <- `0.0.0.0:${rpc_port}:${rpc_port}`
  affinity:
    defines: affinity
    tag: service
  variables:
    self_id: "da-explorer-1" 
    name: EXPLORER_1
    node_key: <- act("/polygon/da-vault/get", "key", "keynode", "path", "secret/da/testnet/da-explorer-1")
    full_node: <- get-hostname("/polygon/da-explorer-1", "da-node")
    redis: <- get-hostname("/polygon/da-explorer-1", "redis")
    dapp: <- get-hostname("/polygon/da-explorer-1", "dapp")
    light_client: <- get-hostname("/polygon/da-light-client", "light_client")
    volume-data: /mnt/volume/da/explorer/1
  volumes:
    defines: volumes
    da_expo_3:
      size: 64
      kind: SSD
      path: <- $volume-data

da-light-client:
  defines: runnable
  containers:
    defines: containers
    light_client:
      image: 0xpolygon/avail-light:data-discovery
      environment:
        - HTTP_SERVER_HOST=0.0.0.0
        - <- "FULL_NODE_RPC=\"http://" get-hostname("/polygon/da-explorer-1", "da-node") ":9933\"" concat-all
        - FULL_NODE_WS="wss://devnet-avail.polygon.technology/ws"
        - RUST_BACKTRACE=full
        - IPFS_PATH=/avail-light/state/ipfs
        - AVAIL_PATH=/avail-light/state/avail
    datadog-agent:
      image: gcr.io/datadoghq/agent:latest
      environment:
        - DD_LOGS_ENABLED=true
        - DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true
        - DD_CONTAINER_EXCLUDE="image:gcr.io/datadoghq/agent image:kong image:0xpolygon/avail-apps"
        - DD_TAGS="da-devnet da-monk da light-client"
        - DD_DOCKER_LABELS_AS_TAGS=true
        - <- "DD_API_KEY=" act("/polygon/da-vault/get", "key", "api_key", "path", "secret/da/testnet/datadog") concat-all
      paths:
        - /var/run/docker.sock:/var/run/docker.sock:ro
        - /var/lib/docker/containers:/var/lib/docker/containers:ro
        - /proc/:/host/proc/:ro
        - /opt/datadog-agent/run:/opt/datadog-agent/run:rw
        - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro 
  affinity:
    defines: affinity
    tag: service
  volumes:
    defines: volumes
    da_light_client:
      size: 16 
      kind: SSD
      path: /avail-light/state

